# Annotation機能（コメント機能）

## 概要

PDF文書上にコメントを追加・編集・削除できる機能です。リアルタイムでの同期に対応しており、複数のユーザーが同時に編集してもリアルタイムで反映されます。

## 機能一覧

### 基本機能

- ✅ **コメント作成**: PDF上の任意の場所をクリックしてコメントを追加
- ✅ **コメント編集**: 既存のコメントをクリックして内容を編集
- ✅ **コメント削除**: 編集画面から削除ボタンで削除
- ✅ **コメント移動**: ドラッグ&ドロップでコメントの位置を変更

### リアルタイム同期

- ✅ **作成の同期**: 他のユーザーが作成したコメントがリアルタイムで表示
- ✅ **更新の同期**: 他のユーザーの編集がリアルタイムで反映
- ✅ **削除の同期**: 他のユーザーが削除したコメントがリアルタイムで削除

### 自動調整機能

- ✅ **重なり検出**: コメント同士の重なりを自動検出
- ✅ **自動配置**: 重なりを避けるための最適な位置に自動調整
- ✅ **新規作成時の重なり回避**: 新しいコメント作成時に既存コメントとの重なりを自動回避

## 使用方法

### 新規コメント作成

1. ツールバーの「📝」ボタンをクリック（コメントモード）
2. PDF上の任意の場所をクリック
3. コメント入力画面でテキストを入力
4. 「保存」ボタンをクリック

### 既存コメント編集

1. ツールバーの「📝」ボタンをクリック（コメントモード）
2. 編集したいコメントをクリック（オレンジ色に変化）
3. コメント編集画面でテキストを修正
4. 「保存」ボタンをクリック

### コメント削除

1. 編集モードでコメントをクリック
2. 編集画面左下の「削除」ボタンをクリック

### コメント移動

1. ツールバーで何も選択していない状態（フリーモード）
2. 移動したいコメントをドラッグ&ドロップ

## リアルタイム同期の仕組み

### サブスクリプション

```typescript
// 作成イベントの監視
client.models.Annotation.onCreate().subscribe();

// 更新イベントの監視
client.models.Annotation.onUpdate().subscribe();

// 削除イベントの監視
client.models.Annotation.onDelete().subscribe();
```

### 楽観的更新との競合回避

- **楽観的更新**: ユーザーの操作に対して即座にUIを更新
- **サブスクリプション更新**: 他のユーザーの変更をリアルタイムで反映
- **競合回避**: 楽観的更新中はサブスクリプション更新をスキップ

### フィルタリング

```typescript
// 現在のドキュメント・ページのみ監視
filter: {
  documentId: { eq: documentId },
  pageNumber: { eq: pageNumber }
}
```

## 技術仕様

### データ構造

```typescript
interface AnnotationType {
  id: string;
  documentId: string;
  pageNumber: number;
  content: string;
  x: number; // コメントボックスX座標
  y: number; // コメントボックスY座標
  leaderX: number; // リーダー線の終点X座標
  leaderY: number; // リーダー線の終点Y座標
  width: number; // コメントボックス幅
  height: number; // コメントボックス高さ
}
```

### AWS Amplifyスキーマ

```typescript
Annotation: a.model({
  documentId: a.id(),
  pageNumber: a.integer(),
  content: a.string(),
  x: a.float(),
  y: a.float(),
  leaderX: a.float(),
  leaderY: a.float(),
  width: a.float(),
  height: a.float(),
});
```

### 状態管理

- **useAnnotations**: CRUD操作とリアルタイム同期
- **楽観的更新トラッキング**: 重複更新の防止
- **サブスクリプション管理**: 自動的なクリーンアップ

## パフォーマンス最適化

### 重複防止

- 作成: IDベースの重複チェック
- 更新: 楽観的更新中はサブスクリプション更新をスキップ
- 削除: 楽観的削除後のサブスクリプション更新は冪等

### メモリ管理

- ページ切り替え時にサブスクリプションを自動的にクリーンアップ
- 不要なサブスクリプションの蓄積を防止

## トラブルシューティング

### リアルタイム同期が動作しない場合

1. AWS Amplifyの設定を確認
2. WebSocket接続の状態を確認
3. フィルター条件が正しいかチェック

### コメントが重複して表示される場合

1. 楽観的更新トラッキングの状態を確認
2. サブスクリプションフィルターを確認
3. ページをリロードして状態をリセット
